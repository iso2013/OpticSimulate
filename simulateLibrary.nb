(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 13.1' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     24616,        616]
NotebookOptionsPosition[     22870,        581]
NotebookOutlinePosition[     23291,        597]
CellTagsIndexPosition[     23248,        594]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{

Cell[CellGroupData[{
Cell["Utility functions:", "Subtitle",
 CellChangeTimes->{{3.8783919977963295`*^9, 3.8783920034925013`*^9}, 
   3.878411255563383*^9},ExpressionUUID->"2721a7f5-4ddf-4257-a80b-\
a28a90a9608e"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
     RowBox[{
     "This", " ", "function", " ", "creates", " ", "the", " ", "matrices", 
      " ", "representing", " ", "the", " ", "global"}], "-", "to", "-", 
     RowBox[{"local", " ", "space", " ", "transformations"}]}], ",", " ", 
    RowBox[{"as", " ", "linear", " ", 
     RowBox[{"transformations", "."}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"LocalSpaceTransform", "[", "coords_", "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"xBase", "=", 
        RowBox[{"{", 
         RowBox[{"1", ",", "0"}], "}"}]}], ",", " ", 
       RowBox[{"yBase", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "1"}], "}"}]}], ",", " ", "rot", ",", "l2g", ",", 
       " ", "g2l"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Multiply", " ", "the", " ", "basis", " ", "vectors", " ", "by", " ", 
       "the", " ", "scale"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"xBase", " ", "=", " ", 
       RowBox[{"xBase", " ", "*", " ", 
        RowBox[{"coords", "[", 
         RowBox[{"[", "4", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"yBase", " ", "=", " ", 
       RowBox[{"yBase", " ", "*", " ", 
        RowBox[{"coords", "[", 
         RowBox[{"[", "4", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"Create", " ", "the", " ", "rotation", " ", "matrix"}], " ", 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{"rot", " ", "=", " ", 
       RowBox[{"RotationMatrix", "[", 
        RowBox[{"coords", "[", 
         RowBox[{"[", "3", "]"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "Rotate", " ", "the", " ", "basis", " ", "vectors", " ", "by", " ", 
        "theta"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"xBase", " ", "=", " ", 
       RowBox[{"rot", ".", "xBase"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"yBase", " ", "=", " ", 
       RowBox[{"rot", ".", "yBase"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "Create", " ", "the", " ", "matrices", " ", "and", " ", "return", " ", 
        "them"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"l2g", " ", "=", " ", 
       RowBox[{"Transpose", "[", 
        RowBox[{"{", 
         RowBox[{"xBase", ",", " ", "yBase"}], "}"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"g2l", " ", "=", " ", 
       RowBox[{"Inverse", "[", "l2g", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Return", "[", 
       RowBox[{"{", 
        RowBox[{"l2g", ",", " ", "g2l"}], "}"}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}]}]], "Input",
 CellChangeTimes->{{3.8783929356696444`*^9, 3.8783929537595916`*^9}, {
  3.878393568124758*^9, 3.8783937372156544`*^9}, {3.8783937754230957`*^9, 
  3.8783939782799463`*^9}, {3.878394047744008*^9, 3.8783940479064713`*^9}, {
  3.878394268789501*^9, 
  3.878394377449495*^9}},ExpressionUUID->"fff4261a-3d7c-450d-b6ce-\
752fc2fac155"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"Get", " ", "Affine", " ", "Space", " ", 
     RowBox[{"Transform", ":", " ", 
      RowBox[{
      "This", " ", "function", " ", "returns", " ", "an", " ", "expression", 
       " ", "that", " ", "can", " ", "be", " ", "evaluated", " ", "at", " ", 
       "coordinates"}]}]}], ",", " ", 
    RowBox[{
    "which", " ", "uses", " ", "the", " ", "local", " ", "space", " ", 
     "transformation", " ", "matrices", " ", "at", " ", "an", " ", "offset", 
     " ", "to", " ", "perform", " ", "the", " ", "affine", " ", "space", " ", 
     RowBox[{"transformation", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"GetAST", "[", "element_", "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"elPos", ",", "linears", ",", " ", "l2g", ",", " ", "g2l"}], 
      "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"elPos", " ", "=", " ", 
       RowBox[{"element", "[", "\"\<position\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"linears", " ", "=", " ", 
       RowBox[{"LocalSpaceTransform", "[", "elPos", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"Hooray", ",", " ", 
        RowBox[{"first", "-", 
         RowBox[{"class", " ", 
          RowBox[{"citizens", "!"}]}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{
        "Create", " ", "a", " ", "matrix", " ", "whose", " ", "first", " ", 
         "column", " ", "is", " ", "the", " ", "offset", " ", "coordinates", 
         " ", "and", " ", "second", " ", "column", " ", "is", " ", "the", " ",
          "velocity", " ", "vector"}], ",", " ", 
        RowBox[{"then", " ", "apply", " ", "the", " ", "g2l", " ", "matrix"}],
         ",", " ", 
        RowBox[{
         RowBox[{"and", " ", "transpose"}], " ", "+", " ", 
         RowBox[{
         "flatten", " ", "the", " ", "matrix", " ", "to", " ", "get", " ", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"x", ",", " ", "y", ",", " ", "xVel", ",", " ", "yVel"}], 
            "}"}], "."}]}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"g2l", "[", "coords_", "]"}], " ", ":=", 
       RowBox[{"Flatten", "[", 
        RowBox[{"Transpose", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"linears", "[", 
           RowBox[{"[", "2", "]"}], "]"}], ".", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"coords", "[", 
                RowBox[{"[", "1", "]"}], "]"}], "-", 
               RowBox[{"elPos", "[", 
                RowBox[{"[", "1", "]"}], "]"}]}], ",", 
              RowBox[{"coords", "[", 
               RowBox[{"[", "3", "]"}], "]"}]}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"coords", "[", 
                RowBox[{"[", "2", "]"}], "]"}], "-", 
               RowBox[{"elPos", "[", 
                RowBox[{"[", "2", "]"}], "]"}]}], ",", 
              RowBox[{"coords", "[", 
               RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], "}"}]}], 
         "\[IndentingNewLine]", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{
        "Reshape", " ", "the", " ", "list", " ", "into", " ", "a", " ", "2", 
         "x2", " ", "matrix"}], ",", " ", 
        RowBox[{
        "and", " ", "transpose", " ", "it", " ", "so", " ", "the", " ", 
         "left", " ", "column", " ", "is", " ", "the", " ", "position"}], ",",
         " ", 
        RowBox[{
        "right", " ", "column", " ", "is", " ", "the", " ", "velocity"}], ",",
         " ", 
        RowBox[{"apply", " ", "the", " ", "l2g", " ", "matrix"}], ",", " ", 
        RowBox[{
        "and", " ", "then", " ", "again", " ", "transpose", " ", "and", " ", 
         "flatten", " ", "to", " ", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"get", " ", "x"}], ",", " ", "y", ",", " ", "xVel", ",", 
           " ", "yVel"}], "}"}]}], ",", " ", 
        RowBox[{"and", " ", "finally", " ", "add", " ", "in", " ", "the", " ", 
         RowBox[{"offset", "."}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"l2g", "[", "coords_", "]"}], ":=", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"elPos", "[", 
           RowBox[{"[", "1", "]"}], "]"}], ",", 
          RowBox[{"elPos", "[", 
           RowBox[{"[", "2", "]"}], "]"}], ",", "0", ",", "0"}], "}"}], " ", 
        "+", 
        RowBox[{"Flatten", "[", 
         RowBox[{"Transpose", "[", 
          RowBox[{
           RowBox[{"linears", "[", 
            RowBox[{"[", "1", "]"}], "]"}], ".", 
           RowBox[{"Transpose", "[", 
            RowBox[{"ArrayReshape", "[", 
             RowBox[{"coords", ",", " ", 
              RowBox[{"{", 
               RowBox[{"2", ",", "2"}], "}"}]}], "]"}], "]"}]}], "]"}], 
         "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Return", "[", 
       RowBox[{"{", 
        RowBox[{"l2g", ",", " ", "g2l"}], "}"}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}]}]], "Input",
 CellChangeTimes->{{3.878394383254222*^9, 3.8783943883836746`*^9}, {
   3.8783944346433287`*^9, 3.87839478888885*^9}, {3.8783948371333976`*^9, 
   3.8783949538359346`*^9}, {3.878394992554572*^9, 3.878395192224355*^9}, {
   3.8784027944436803`*^9, 3.8784030699780693`*^9}, 3.8784054823945923`*^9, {
   3.878406806931327*^9, 3.8784069379684076`*^9}},
 CellLabel->"In[95]:=",ExpressionUUID->"22dbdbaf-fc12-4a2b-9c4b-17fb2b017295"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
   "Generate", " ", "the", " ", "transforms", " ", "for", " ", "several", " ",
     "elements", " ", "and", " ", "insert", " ", "them", " ", "into", " ", 
    "the", " ", 
    RowBox[{"elements", "."}]}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"GenerateASTs", "[", "elements_", "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"gen", ",", " ", "result"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"result", "=", 
       RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"Do", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"gen", "=", 
          RowBox[{"GetAST", "[", "entry", "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"entry", "[", "\"\<l2g\>\"", "]"}], "=", 
          RowBox[{"gen", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"entry", "[", "\"\<g2l\>\"", "]"}], "=", 
          RowBox[{"gen", "[", 
           RowBox[{"[", "2", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"result", ",", " ", "entry"}], "]"}], ";"}], 
        "\[IndentingNewLine]", ",", " ", 
        RowBox[{"{", 
         RowBox[{"entry", ",", " ", "elements"}], "}"}]}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"Return", "[", "result", "]"}]}]}], "\[IndentingNewLine]", 
    "]"}]}]}]], "Input",
 CellChangeTimes->{{3.87840694413439*^9, 3.8784071475732822`*^9}, {
  3.878407182972122*^9, 3.878407187751275*^9}},
 CellLabel->
  "In[125]:=",ExpressionUUID->"178196de-50ca-489f-8b47-c863725895d8"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
   "A", " ", "function", " ", "to", " ", "do", " ", "a", " ", "quick", " ", 
    "check", " ", "to", " ", "see", " ", "if", " ", "two", " ", "points", " ",
     "are", " ", "within", " ", "a", " ", "given", " ", "distance", " ", "of",
     " ", "each", " ", "other"}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"DistanceCheck", "[", 
    RowBox[{"coords_", ",", " ", "elPos_"}], "]"}], " ", ":=", " ", 
   RowBox[{
    RowBox[{"(", 
     RowBox[{
      RowBox[{"(", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{
          RowBox[{"coords", "[", 
           RowBox[{"[", "1", "]"}], "]"}], "-", 
          RowBox[{"elPos", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}], ")"}], " ", "^", " ", "2"}], 
       ")"}], " ", "+", " ", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{
          RowBox[{"coords", "[", 
           RowBox[{"[", "2", "]"}], "]"}], "-", 
          RowBox[{"elPos", "[", 
           RowBox[{"[", "2", "]"}], "]"}]}], ")"}], " ", "^", " ", "2"}], 
       ")"}]}], ")"}], " ", "<=", " ", 
    RowBox[{"(", 
     RowBox[{
      RowBox[{"elPos", "[", 
       RowBox[{"[", "4", "]"}], "]"}], " ", "^", " ", "2"}], 
     ")"}]}]}]}]], "Input",
 CellChangeTimes->{{3.8784058310191875`*^9, 3.8784059105815024`*^9}, {
  3.8784060931577177`*^9, 3.8784061094464164`*^9}, {3.878406568440184*^9, 
  3.87840661108875*^9}},
 CellLabel->
  "In[126]:=",ExpressionUUID->"eba29eb1-59bf-4695-ace5-bca8568c2336"]
}, Open  ]],

Cell[CellGroupData[{

Cell["\<\

Actual Implementation Functions:\
\>", "Subtitle",
 CellChangeTimes->{{3.878392043297135*^9, 3.8783920484163265`*^9}, {
  3.8784112254583044`*^9, 
  3.878411244795863*^9}},ExpressionUUID->"337f5d3f-2283-47e0-9508-\
051921e559d7"],

Cell["Photon simulation function:", "Text",
 CellChangeTimes->{
  3.8784112473482327`*^9},ExpressionUUID->"7e075a3e-631e-44f6-9b82-\
59f4916dfc1f"],

Cell[BoxData[
 RowBox[{
  RowBox[{"SimulPhoton", "[", 
   RowBox[{"elements_", ",", " ", "coords_"}], "]"}], " ", ":=", " ", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"pos", ",", " ", "elLoc", ",", " ", "local"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"pos", " ", "=", " ", "coords"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"Do", "[", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{"If", " ", "we", " ", 
         RowBox[{"aren", "'"}], "t", " ", "in", " ", "the", " ", "radial", 
         " ", "distance", " ", "of", " ", "the", " ", "element"}], ",", " ", 
        RowBox[{"skip", " ", "the", " ", 
         RowBox[{"element", "."}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"!", 
           RowBox[{"DistanceCheck", "[", 
            RowBox[{"pos", ",", " ", 
             RowBox[{"entry", "[", "\"\<position\>\"", "]"}]}], "]"}]}], ",", 
          " ", 
          RowBox[{"Continue", "[", "]"}]}], "]"}], ";", "\[IndentingNewLine]",
         "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
         "Transform", " ", "to", " ", "the", " ", "local", " ", "space", " ", 
          "using", " ", "the", " ", "proper", " ", "function"}], " ", "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{"local", " ", "=", " ", 
         RowBox[{
          RowBox[{"entry", "[", "\"\<g2l\>\"", "]"}], "[", "pos", "]"}]}], 
        ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
          RowBox[{"Check", " ", "the", " ", 
           RowBox[{"element", "'"}], "s", " ", "check", " ", "function"}], 
          "..."}], " ", "*)"}], "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"!", 
           RowBox[{
            RowBox[{"entry", "[", "\"\<check\>\"", "]"}], "[", "local", 
            "]"}]}], ",", " ", 
          RowBox[{"Continue", "[", "]"}]}], "]"}], ";", "\[IndentingNewLine]",
         "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
          RowBox[{
          "Apply", " ", "the", " ", "update", " ", "function", " ", "to", " ",
            "the", " ", "particle"}], "..."}], " ", "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{"local", " ", "=", " ", 
         RowBox[{
          RowBox[{"entry", "[", "\"\<update\>\"", "]"}], "[", "local", 
          "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{"Convert", " ", "back", " ", "to", " ", "global", " ", 
          RowBox[{"coordinates", "."}]}], " ", "*)"}], "\[IndentingNewLine]", 
        RowBox[{"pos", " ", "=", " ", 
         RowBox[{
          RowBox[{"entry", "[", "\"\<l2g\>\"", "]"}], "[", "local", "]"}]}]}],
        ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"entry", ",", " ", "elements"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"Return", "[", "pos", "]"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]], "Input",
 CellChangeTimes->{
  3.878392140325099*^9, {3.8784054966406107`*^9, 3.8784055793302655`*^9}, {
   3.87840562179473*^9, 3.8784056921779575`*^9}, {3.878406150258818*^9, 
   3.878406283277363*^9}, {3.87840637599865*^9, 3.8784064683033094`*^9}, {
   3.8784065269185753`*^9, 3.8784065604021864`*^9}, {3.878406643433539*^9, 
   3.8784067503815312`*^9}},
 CellLabel->
  "In[129]:=",ExpressionUUID->"2af5c833-3f8a-450b-be20-c8e5b9002d07"],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{"elems", " ", "=", " ", 
   RowBox[{"{", 
    RowBox[{"BasicMirror", "[", 
     RowBox[{"0", ",", "0", ",", "0", ",", "1"}], "]"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"elems", " ", "=", " ", 
   RowBox[{"GenerateASTs", "[", "elems", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{"SimulPhoton", "[", 
  RowBox[{"elems", ",", " ", 
   RowBox[{"{", 
    RowBox[{"0.99", ",", "0.1", ",", "0", ",", 
     RowBox[{"-", "0.2"}]}], "}"}]}], "]"}]}], "Input",
 CellChangeTimes->{{3.8784110291947303`*^9, 3.878411036645265*^9}, {
  3.878411084614817*^9, 3.878411199663193*^9}},
 CellLabel->
  "In[162]:=",ExpressionUUID->"53dcb814-1cd1-4007-8cf6-44ac786122af"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"0.99`", ",", "0.1`", ",", "0.`", ",", "0.2`"}], "}"}]], "Output",
 CellChangeTimes->{{3.878411100675001*^9, 3.878411200278002*^9}},
 CellLabel->
  "Out[164]=",ExpressionUUID->"5aff3806-0bb5-4432-b7d9-e85fdf5f3441"]
}, Open  ]],

Cell["Element Functions:", "Text",
 CellChangeTimes->{{3.878407255138899*^9, 3.878407276163238*^9}, {
  3.8784112899193497`*^9, 
  3.8784112934464054`*^9}},ExpressionUUID->"7dd032cb-f0ed-41ac-b7aa-\
8e91ade66f88"],

Cell[BoxData[
 RowBox[{
  RowBox[{"BasicMirror", "[", 
   RowBox[{"elX_", ",", "elY_", ",", "elTheta_", ",", "elScale_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"check", ",", " ", "update", ",", "  ", "render"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"check", "[", "pos_", "]"}], " ", ":=", " ", 
      RowBox[{
       RowBox[{"Sign", "[", 
        RowBox[{"pos", "[", 
         RowBox[{"[", "2", "]"}], "]"}], "]"}], "!=", 
       RowBox[{"Sign", "[", 
        RowBox[{
         RowBox[{"pos", "[", 
          RowBox[{"[", "2", "]"}], "]"}], " ", "+", " ", 
         RowBox[{"pos", "[", 
          RowBox[{"[", "4", "]"}], "]"}]}], "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"update", "[", "pos_", "]"}], " ", ":=", " ", 
      RowBox[{"Module", "[", 
       RowBox[{
        RowBox[{"{", "res", "}"}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"res", " ", "=", " ", "pos"}], ";", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"res", "[", 
           RowBox[{"[", "4", "]"}], "]"}], " ", "=", " ", 
          RowBox[{"-", 
           RowBox[{"res", "[", 
            RowBox[{"[", "4", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"Return", "[", "res", "]"}]}]}], "\[IndentingNewLine]", 
       "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"render", "[", 
       RowBox[{"x_", ",", " ", "y_", ",", " ", "theta_", ",", " ", "scale_"}],
        "]"}], " ", ":=", " ", 
      RowBox[{"Module", "[", 
       RowBox[{
        RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
        RowBox[{"Return", "[", 
         RowBox[{"{", 
          RowBox[{"Black", ",", " ", 
           RowBox[{"Thickness", "[", "0.01", "]"}], ",", " ", 
           RowBox[{"Line", "[", 
            RowBox[{"{", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"0.5", " ", "scale", " ", 
                   RowBox[{"Sin", "[", 
                    RowBox[{"theta", "+", "Pi"}], "]"}]}], ")"}], " ", "+", 
                 " ", "x"}], ",", " ", 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"0.5", " ", "scale", " ", 
                   RowBox[{"Cos", "[", 
                    RowBox[{"theta", "+", "Pi"}], "]"}]}], ")"}], " ", "+", 
                 " ", "y"}]}], "}"}], ",", " ", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"0.5", "scale", " ", 
                   RowBox[{"Sin", "[", "theta", "]"}]}], ")"}], " ", "+", " ",
                  "x"}], ",", " ", 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"0.5", "scale", " ", 
                   RowBox[{"Cos", "[", "theta", "]"}]}], ")"}], " ", "+", " ",
                  "y"}]}], "}"}]}], "\[IndentingNewLine]", "}"}], "]"}]}], 
          "}"}], "]"}]}], "\[IndentingNewLine]", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Return", "[", 
      RowBox[{"<|", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"\"\<position\>\"", "->", 
         RowBox[{"{", 
          RowBox[{
          "elX", ",", " ", "elY", ",", " ", "elTheta", ",", " ", "elScale"}], 
          "}"}]}], ",", "\[IndentingNewLine]", 
        RowBox[{"\"\<check\>\"", "->", " ", "check"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"\"\<update\>\"", "->", " ", "update"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"\"\<graphics\>\"", " ", "->", " ", "render"}]}], 
       "\[IndentingNewLine]", "|>"}], "]"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.878407325716136*^9, 3.8784074650096145`*^9}, {
  3.878411041545141*^9, 3.8784110794542007`*^9}},
 CellLabel->
  "In[130]:=",ExpressionUUID->"c17c50a1-f920-4dc6-95f9-8f16c2a42811"],

Cell[CellGroupData[{

Cell[BoxData[""], "Input",
 CellChangeTimes->{{3.878405709219878*^9, 3.878405727795679*^9}, {
  3.8784057947378635`*^9, 
  3.8784058239345336`*^9}},ExpressionUUID->"621e5bc2-2416-44da-a05b-\
9e74cb3bacaf"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{"0", ",", "1", ",", "2"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"1", ",", "0", ",", "1"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"2", ",", "1", ",", "0"}], "}"}]}], "}"}]], "Output",
 CellChangeTimes->{3.878405715979273*^9},
 CellLabel->"Out[88]=",ExpressionUUID->"f79fea1f-3f0c-4479-aa91-dfbcaf7c39c3"]
}, Open  ]]
}, Open  ]]
},
WindowSize->{766.8, 820.8},
WindowMargins->{{Automatic, -4.7999999999999545`}, {Automatic, 0}},
FrontEndVersion->"13.1 for Microsoft Windows (64-bit) (August 22, 2022)",
StyleDefinitions->"Default.nb",
ExpressionUUID->"76737a91-7d1d-4304-848f-7779118f13a9"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[CellGroupData[{
Cell[580, 22, 191, 3, 53, "Subtitle",ExpressionUUID->"2721a7f5-4ddf-4257-a80b-a28a90a9608e"],
Cell[774, 27, 3138, 72, 314, "Input",ExpressionUUID->"fff4261a-3d7c-450d-b6ce-752fc2fac155"],
Cell[3915, 101, 5696, 131, 428, "Input",ExpressionUUID->"22dbdbaf-fc12-4a2b-9c4b-17fb2b017295"],
Cell[9614, 234, 1793, 42, 257, "Input",ExpressionUUID->"178196de-50ca-489f-8b47-c863725895d8"],
Cell[11410, 278, 1530, 41, 86, "Input",ExpressionUUID->"eba29eb1-59bf-4695-ace5-bca8568c2336"]
}, Open  ]],
Cell[CellGroupData[{
Cell[12977, 324, 240, 7, 85, "Subtitle",ExpressionUUID->"337f5d3f-2283-47e0-9508-051921e559d7"],
Cell[13220, 333, 147, 3, 35, "Text",ExpressionUUID->"7e075a3e-631e-44f6-9b82-59f4916dfc1f"],
Cell[13370, 338, 3633, 82, 447, "Input",ExpressionUUID->"2af5c833-3f8a-450b-be20-c8e5b9002d07"],
Cell[CellGroupData[{
Cell[17028, 424, 719, 19, 67, "Input",ExpressionUUID->"53dcb814-1cd1-4007-8cf6-44ac786122af"],
Cell[17750, 445, 254, 5, 32, "Output",ExpressionUUID->"5aff3806-0bb5-4432-b7d9-e85fdf5f3441"]
}, Open  ]],
Cell[18019, 453, 213, 4, 35, "Text",ExpressionUUID->"7dd032cb-f0ed-41ac-b7aa-8e91ade66f88"],
Cell[18235, 459, 3993, 98, 390, "Input",ExpressionUUID->"c17c50a1-f920-4dc6-95f9-8f16c2a42811"],
Cell[CellGroupData[{
Cell[22253, 561, 205, 4, 28, "Input",ExpressionUUID->"621e5bc2-2416-44da-a05b-9e74cb3bacaf"],
Cell[22461, 567, 381, 10, 32, "Output",ExpressionUUID->"f79fea1f-3f0c-4479-aa91-dfbcaf7c39c3"]
}, Open  ]]
}, Open  ]]
}
]
*)

