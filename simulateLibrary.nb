(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 13.1' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     34889,        843]
NotebookOptionsPosition[     33173,        810]
NotebookOutlinePosition[     33594,        826]
CellTagsIndexPosition[     33551,        823]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{

Cell[CellGroupData[{
Cell["Utility functions:", "Subtitle",
 CellChangeTimes->{{3.8783919977963295`*^9, 3.8783920034925013`*^9}, 
   3.878411255563383*^9},ExpressionUUID->"2721a7f5-4ddf-4257-a80b-\
a28a90a9608e"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
     RowBox[{
     "This", " ", "function", " ", "creates", " ", "the", " ", "matrices", 
      " ", "representing", " ", "the", " ", "global"}], "-", "to", "-", 
     RowBox[{"local", " ", "space", " ", "transformations"}]}], ",", " ", 
    RowBox[{"as", " ", "linear", " ", 
     RowBox[{"transformations", "."}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"LocalSpaceTransform", "[", "coords_", "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"xBase", "=", 
        RowBox[{"{", 
         RowBox[{"1", ",", "0"}], "}"}]}], ",", " ", 
       RowBox[{"yBase", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "1"}], "}"}]}], ",", " ", "rot", ",", "l2g", ",", 
       " ", "g2l"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Multiply", " ", "the", " ", "basis", " ", "vectors", " ", "by", " ", 
       "the", " ", "scale"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"xBase", " ", "=", " ", 
       RowBox[{"xBase", " ", "*", " ", 
        RowBox[{"coords", "[", 
         RowBox[{"[", "4", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"yBase", " ", "=", " ", 
       RowBox[{"yBase", " ", "*", " ", 
        RowBox[{"coords", "[", 
         RowBox[{"[", "4", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"Create", " ", "the", " ", "rotation", " ", "matrix"}], " ", 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{"rot", " ", "=", " ", 
       RowBox[{"RotationMatrix", "[", 
        RowBox[{"coords", "[", 
         RowBox[{"[", "3", "]"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "Rotate", " ", "the", " ", "basis", " ", "vectors", " ", "by", " ", 
        "theta"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"xBase", " ", "=", " ", 
       RowBox[{"rot", ".", "xBase"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"yBase", " ", "=", " ", 
       RowBox[{"rot", ".", "yBase"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "Create", " ", "the", " ", "matrices", " ", "and", " ", "return", " ", 
        "them"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"l2g", " ", "=", " ", 
       RowBox[{"Transpose", "[", 
        RowBox[{"{", 
         RowBox[{"xBase", ",", " ", "yBase"}], "}"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"g2l", " ", "=", " ", 
       RowBox[{"Inverse", "[", "l2g", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Return", "[", 
       RowBox[{"{", 
        RowBox[{"l2g", ",", " ", "g2l"}], "}"}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}]}]], "Input",
 CellChangeTimes->{{3.8783929356696444`*^9, 3.8783929537595916`*^9}, {
  3.878393568124758*^9, 3.8783937372156544`*^9}, {3.8783937754230957`*^9, 
  3.8783939782799463`*^9}, {3.878394047744008*^9, 3.8783940479064713`*^9}, {
  3.878394268789501*^9, 3.878394377449495*^9}},
 CellLabel->"In[1]:=",ExpressionUUID->"fff4261a-3d7c-450d-b6ce-752fc2fac155"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"Get", " ", "Affine", " ", "Space", " ", 
     RowBox[{"Transform", ":", " ", 
      RowBox[{
      "This", " ", "function", " ", "returns", " ", "an", " ", "expression", 
       " ", "that", " ", "can", " ", "be", " ", "evaluated", " ", "at", " ", 
       "coordinates"}]}]}], ",", " ", 
    RowBox[{
    "which", " ", "uses", " ", "the", " ", "local", " ", "space", " ", 
     "transformation", " ", "matrices", " ", "at", " ", "an", " ", "offset", 
     " ", "to", " ", "perform", " ", "the", " ", "affine", " ", "space", " ", 
     RowBox[{"transformation", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"GetAST", "[", "element_", "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"elPos", ",", "linears", ",", " ", "l2g", ",", " ", "g2l"}], 
      "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"elPos", " ", "=", " ", 
       RowBox[{"element", "[", "\"\<position\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"linears", " ", "=", " ", 
       RowBox[{"LocalSpaceTransform", "[", "elPos", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"Hooray", ",", " ", 
        RowBox[{"first", "-", 
         RowBox[{"class", " ", 
          RowBox[{"citizens", "!"}]}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{
        "Create", " ", "a", " ", "matrix", " ", "whose", " ", "first", " ", 
         "column", " ", "is", " ", "the", " ", "offset", " ", "coordinates", 
         " ", "and", " ", "second", " ", "column", " ", "is", " ", "the", " ",
          "velocity", " ", "vector"}], ",", " ", 
        RowBox[{"then", " ", "apply", " ", "the", " ", "g2l", " ", "matrix"}],
         ",", " ", 
        RowBox[{
         RowBox[{"and", " ", "transpose"}], " ", "+", " ", 
         RowBox[{
         "flatten", " ", "the", " ", "matrix", " ", "to", " ", "get", " ", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"x", ",", " ", "y", ",", " ", "xVel", ",", " ", "yVel"}], 
            "}"}], "."}]}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"g2l", "[", "coords_", "]"}], " ", ":=", 
       RowBox[{"Flatten", "[", 
        RowBox[{"Transpose", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"linears", "[", 
           RowBox[{"[", "2", "]"}], "]"}], ".", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"coords", "[", 
                RowBox[{"[", "1", "]"}], "]"}], "-", 
               RowBox[{"elPos", "[", 
                RowBox[{"[", "1", "]"}], "]"}]}], ",", 
              RowBox[{"coords", "[", 
               RowBox[{"[", "3", "]"}], "]"}]}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"coords", "[", 
                RowBox[{"[", "2", "]"}], "]"}], "-", 
               RowBox[{"elPos", "[", 
                RowBox[{"[", "2", "]"}], "]"}]}], ",", 
              RowBox[{"coords", "[", 
               RowBox[{"[", "4", "]"}], "]"}]}], "}"}]}], "}"}]}], 
         "\[IndentingNewLine]", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{
        "Reshape", " ", "the", " ", "list", " ", "into", " ", "a", " ", "2", 
         "x2", " ", "matrix"}], ",", " ", 
        RowBox[{
        "and", " ", "transpose", " ", "it", " ", "so", " ", "the", " ", 
         "left", " ", "column", " ", "is", " ", "the", " ", "position"}], ",",
         " ", 
        RowBox[{
        "right", " ", "column", " ", "is", " ", "the", " ", "velocity"}], ",",
         " ", 
        RowBox[{"apply", " ", "the", " ", "l2g", " ", "matrix"}], ",", " ", 
        RowBox[{
        "and", " ", "then", " ", "again", " ", "transpose", " ", "and", " ", 
         "flatten", " ", "to", " ", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"get", " ", "x"}], ",", " ", "y", ",", " ", "xVel", ",", 
           " ", "yVel"}], "}"}]}], ",", " ", 
        RowBox[{"and", " ", "finally", " ", "add", " ", "in", " ", "the", " ", 
         RowBox[{"offset", "."}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"l2g", "[", "coords_", "]"}], ":=", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"elPos", "[", 
           RowBox[{"[", "1", "]"}], "]"}], ",", 
          RowBox[{"elPos", "[", 
           RowBox[{"[", "2", "]"}], "]"}], ",", "0", ",", "0"}], "}"}], " ", 
        "+", 
        RowBox[{"Flatten", "[", 
         RowBox[{"Transpose", "[", 
          RowBox[{
           RowBox[{"linears", "[", 
            RowBox[{"[", "1", "]"}], "]"}], ".", 
           RowBox[{"Transpose", "[", 
            RowBox[{"ArrayReshape", "[", 
             RowBox[{"coords", ",", " ", 
              RowBox[{"{", 
               RowBox[{"2", ",", "2"}], "}"}]}], "]"}], "]"}]}], "]"}], 
         "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Return", "[", 
       RowBox[{"{", 
        RowBox[{"l2g", ",", " ", "g2l"}], "}"}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}]}]], "Input",
 CellChangeTimes->{{3.878394383254222*^9, 3.8783943883836746`*^9}, {
   3.8783944346433287`*^9, 3.87839478888885*^9}, {3.8783948371333976`*^9, 
   3.8783949538359346`*^9}, {3.878394992554572*^9, 3.878395192224355*^9}, {
   3.8784027944436803`*^9, 3.8784030699780693`*^9}, 3.8784054823945923`*^9, {
   3.878406806931327*^9, 3.8784069379684076`*^9}},
 CellLabel->"In[2]:=",ExpressionUUID->"22dbdbaf-fc12-4a2b-9c4b-17fb2b017295"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
   "Generate", " ", "the", " ", "transforms", " ", "for", " ", "several", " ",
     "elements", " ", "and", " ", "insert", " ", "them", " ", "into", " ", 
    "the", " ", 
    RowBox[{"elements", "."}]}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"GenerateASTs", "[", "elements_", "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"gen", ",", " ", "result"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"result", "=", 
       RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"Do", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"gen", "=", 
          RowBox[{"GetAST", "[", "entry", "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"entry", "[", "\"\<l2g\>\"", "]"}], "=", 
          RowBox[{"gen", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"entry", "[", "\"\<g2l\>\"", "]"}], "=", 
          RowBox[{"gen", "[", 
           RowBox[{"[", "2", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"result", ",", " ", "entry"}], "]"}], ";"}], 
        "\[IndentingNewLine]", ",", " ", 
        RowBox[{"{", 
         RowBox[{"entry", ",", " ", "elements"}], "}"}]}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"Return", "[", "result", "]"}]}]}], "\[IndentingNewLine]", 
    "]"}]}]}]], "Input",
 CellChangeTimes->{{3.87840694413439*^9, 3.8784071475732822`*^9}, {
  3.878407182972122*^9, 3.878407187751275*^9}},
 CellLabel->"In[3]:=",ExpressionUUID->"178196de-50ca-489f-8b47-c863725895d8"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
   "A", " ", "function", " ", "to", " ", "do", " ", "a", " ", "quick", " ", 
    "check", " ", "to", " ", "see", " ", "if", " ", "two", " ", "points", " ",
     "are", " ", "within", " ", "a", " ", "given", " ", "distance", " ", "of",
     " ", "each", " ", "other"}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"DistanceCheck", "[", 
    RowBox[{"coords_", ",", " ", "elPos_"}], "]"}], " ", ":=", " ", 
   RowBox[{
    RowBox[{"(", 
     RowBox[{
      RowBox[{"(", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{
          RowBox[{"coords", "[", 
           RowBox[{"[", "1", "]"}], "]"}], "-", 
          RowBox[{"elPos", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}], ")"}], " ", "^", " ", "2"}], 
       ")"}], " ", "+", " ", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{
          RowBox[{"coords", "[", 
           RowBox[{"[", "2", "]"}], "]"}], "-", 
          RowBox[{"elPos", "[", 
           RowBox[{"[", "2", "]"}], "]"}]}], ")"}], " ", "^", " ", "2"}], 
       ")"}]}], ")"}], " ", "<=", " ", 
    RowBox[{"(", 
     RowBox[{
      RowBox[{"elPos", "[", 
       RowBox[{"[", "4", "]"}], "]"}], " ", "^", " ", "2"}], 
     ")"}]}]}]}]], "Input",
 CellChangeTimes->{{3.8784058310191875`*^9, 3.8784059105815024`*^9}, {
  3.8784060931577177`*^9, 3.8784061094464164`*^9}, {3.878406568440184*^9, 
  3.87840661108875*^9}},
 CellLabel->"In[4]:=",ExpressionUUID->"eba29eb1-59bf-4695-ace5-bca8568c2336"]
}, Open  ]],

Cell[CellGroupData[{

Cell["\<\

Actual Implementation Functions:\
\>", "Subtitle",
 CellChangeTimes->{{3.878392043297135*^9, 3.8783920484163265`*^9}, {
  3.8784112254583044`*^9, 
  3.878411244795863*^9}},ExpressionUUID->"337f5d3f-2283-47e0-9508-\
051921e559d7"],

Cell["Photon simulation function:", "Text",
 CellChangeTimes->{
  3.8784112473482327`*^9},ExpressionUUID->"7e075a3e-631e-44f6-9b82-\
59f4916dfc1f"],

Cell[BoxData[
 RowBox[{
  RowBox[{"SimulPhoton", "[", 
   RowBox[{"elements_", ",", " ", "coords_"}], "]"}], " ", ":=", " ", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"pos", ",", " ", "elLoc", ",", " ", "local"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"pos", " ", "=", " ", "coords"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"Do", "[", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{"If", " ", "we", " ", 
         RowBox[{"aren", "'"}], "t", " ", "in", " ", "the", " ", "radial", 
         " ", "distance", " ", "of", " ", "the", " ", "element"}], ",", " ", 
        RowBox[{"skip", " ", "the", " ", 
         RowBox[{"element", "."}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"!", 
           RowBox[{"DistanceCheck", "[", 
            RowBox[{"pos", ",", " ", 
             RowBox[{"entry", "[", "\"\<position\>\"", "]"}]}], "]"}]}], ",", 
          " ", 
          RowBox[{"Continue", "[", "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
         "Transform", " ", "to", " ", "the", " ", "local", " ", "space", " ", 
          "using", " ", "the", " ", "proper", " ", "function"}], " ", "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{"local", " ", "=", " ", 
         RowBox[{
          RowBox[{"entry", "[", "\"\<g2l\>\"", "]"}], "[", "pos", "]"}]}], 
        ";", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
          RowBox[{"Check", " ", "the", " ", 
           RowBox[{"element", "'"}], "s", " ", "check", " ", "function"}], 
          "..."}], " ", "*)"}], "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"!", 
           RowBox[{
            RowBox[{"entry", "[", "\"\<check\>\"", "]"}], "[", "local", 
            "]"}]}], ",", " ", 
          RowBox[{"Continue", "[", "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
          RowBox[{
          "Apply", " ", "the", " ", "update", " ", "function", " ", "to", " ",
            "the", " ", "particle"}], "..."}], " ", "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{"local", " ", "=", " ", 
         RowBox[{
          RowBox[{"entry", "[", "\"\<update\>\"", "]"}], "[", "local", 
          "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{"Convert", " ", "back", " ", "to", " ", "global", " ", 
          RowBox[{"coordinates", "."}]}], " ", "*)"}], "\[IndentingNewLine]", 
        RowBox[{"pos", " ", "=", " ", 
         RowBox[{
          RowBox[{"entry", "[", "\"\<l2g\>\"", "]"}], "[", "local", "]"}]}]}],
        ",", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"entry", ",", " ", "elements"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"Return", "[", "pos", "]"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]], "Input",
 CellChangeTimes->{
  3.878392140325099*^9, {3.8784054966406107`*^9, 3.8784055793302655`*^9}, {
   3.87840562179473*^9, 3.8784056921779575`*^9}, {3.878406150258818*^9, 
   3.878406283277363*^9}, {3.87840637599865*^9, 3.8784064683033094`*^9}, {
   3.8784065269185753`*^9, 3.8784065604021864`*^9}, {3.878406643433539*^9, 
   3.8784067503815312`*^9}, {3.878411625857558*^9, 3.8784116323174257`*^9}},
 CellLabel->"In[5]:=",ExpressionUUID->"2af5c833-3f8a-450b-be20-c8e5b9002d07"],

Cell["Beam simulation function:", "Text",
 CellChangeTimes->{{3.8784113738939114`*^9, 
  3.878411377269803*^9}},ExpressionUUID->"effa050d-f55b-4328-ad6f-\
4911e89fddc2"],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"SimulBeam", "[", 
    RowBox[{
    "dims_", ",", " ", "elements_", ",", " ", "coords_", ",", " ", 
     "execLimit_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"result", ",", " ", "photon", ",", " ", "execs"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"result", " ", "=", " ", 
       RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"photon", " ", "=", " ", "coords"}], ";", "\[IndentingNewLine]", 
      RowBox[{"execs", " ", "=", " ", "0"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"While", "[", 
       RowBox[{
        RowBox[{"execs", " ", "<", " ", "execLimit"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
         "Advance", " ", "the", " ", "photon", " ", "by", " ", "running", " ",
           "the", " ", "simulation", " ", "once"}], " ", "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"photon", " ", "=", " ", 
          RowBox[{"SimulPhoton", "[", 
           RowBox[{"elements", ",", " ", "photon"}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{
          "Apply", " ", "the", " ", "velocity", " ", "of", " ", "the", " ", 
           "photon"}], " ", "*)"}], "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"photon", "[", 
           RowBox[{"[", "1", "]"}], "]"}], "=", 
          RowBox[{
           RowBox[{"photon", "[", 
            RowBox[{"[", "1", "]"}], "]"}], "+", 
           RowBox[{"photon", "[", 
            RowBox[{"[", "3", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"photon", "[", 
           RowBox[{"[", "2", "]"}], "]"}], "=", 
          RowBox[{
           RowBox[{"photon", "[", 
            RowBox[{"[", "2", "]"}], "]"}], "+", 
           RowBox[{"photon", "[", 
            RowBox[{"[", "4", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{
           RowBox[{"If", " ", 
            RowBox[{"it", "'"}], "s", " ", "out", " ", "of", " ", "bounds"}], 
           ",", " ", "break"}], " ", "*)"}], "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"photon", "[", 
             RowBox[{"[", "1", "]"}], "]"}], "<", 
            RowBox[{
             RowBox[{"-", 
              RowBox[{"dims", "[", 
               RowBox[{"[", "1", "]"}], "]"}]}], "/", "2"}]}], ",", " ", 
           RowBox[{"Break", "[", "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"photon", "[", 
             RowBox[{"[", "1", "]"}], "]"}], ">", 
            RowBox[{
             RowBox[{"dims", "[", 
              RowBox[{"[", "1", "]"}], "]"}], "/", "2"}]}], ",", " ", 
           RowBox[{"Break", "[", "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"photon", "[", 
             RowBox[{"[", "2", "]"}], "]"}], "<", 
            RowBox[{
             RowBox[{"-", 
              RowBox[{"dims", "[", 
               RowBox[{"[", "2", "]"}], "]"}]}], "/", "2"}]}], ",", " ", 
           RowBox[{"Break", "[", "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"photon", "[", 
             RowBox[{"[", "2", "]"}], "]"}], ">", 
            RowBox[{
             RowBox[{"dims", "[", 
              RowBox[{"[", "2", "]"}], "]"}], "/", "2"}]}], ",", " ", 
           RowBox[{"Break", "[", "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{"Append", " ", "the", " ", "resulting", " ", 
           RowBox[{"photon", "'"}], "s", " ", "position"}], " ", "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{"AppendTo", "[", 
          RowBox[{"result", ",", " ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"photon", "[", 
              RowBox[{"[", "1", "]"}], "]"}], ",", 
             RowBox[{"photon", "[", 
              RowBox[{"[", "2", "]"}], "]"}]}], "}"}]}], "]"}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{"Increment", " ", "the", " ", "execution", " ", "counter"}],
           " ", "*)"}], "\[IndentingNewLine]", 
         RowBox[{"execs", " ", "=", " ", 
          RowBox[{"execs", " ", "+", " ", "1"}]}], ";"}]}], 
       "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"Return", "[", "result", "]"}]}]}], "\[IndentingNewLine]", 
    "]"}]}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"scale", " ", "=", " ", 
   RowBox[{"1", "/", "2"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"x", " ", "=", " ", "0"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"yE", "=", "0"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"theta", "=", "0"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"elems", " ", "=", " ", 
   RowBox[{"{", 
    RowBox[{"BasicMirror", "[", 
     RowBox[{"x", ",", "yE", ",", "theta", ",", "scale"}], "]"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"elems", " ", "=", " ", 
    RowBox[{"GenerateASTs", "[", "elems", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{"Manipulate", "[", "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"Animate", "[", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"Graphics", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"LightGray", ",", 
         RowBox[{"Rectangle", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{
              RowBox[{"-", 
               RowBox[{"(", "4", ")"}]}], "/", "2"}], ",", " ", 
             RowBox[{
              RowBox[{"-", 
               RowBox[{"(", "3", ")"}]}], "/", "2"}]}], "}"}], ",", " ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{
              RowBox[{"(", "4", ")"}], "/", "2"}], ",", " ", 
             RowBox[{
              RowBox[{"(", "3", ")"}], "/", "2"}]}], "}"}]}], "]"}], ",", 
         "Blue", ",", 
         RowBox[{"PointSize", "[", "0.01", "]"}], ",", 
         RowBox[{"Point", "[", 
          RowBox[{"SimulBeam", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"4", ",", "3"}], "}"}], ",", "elems", ",", 
            RowBox[{"{", 
             RowBox[{"x2", ",", "y", ",", "0.005", ",", 
              RowBox[{"-", "0.005"}]}], "}"}], ",", " ", "1000"}], "]"}], 
          "]"}], ",", " ", "Black", ",", " ", 
         RowBox[{"Thickness", "[", "0.01", "]"}], ",", " ", 
         RowBox[{"Line", "[", 
          RowBox[{"{", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"-", "scale"}], " ", 
                 RowBox[{"Cos", "[", "theta", "]"}]}], ")"}], " ", "+", " ", 
               "x"}], ",", " ", 
              RowBox[{
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"-", "0.5"}], " ", "scale", " ", 
                 RowBox[{"Sin", "[", "theta", "]"}]}], ")"}], " ", "+", " ", 
               "yE"}]}], "}"}], ",", " ", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"(", 
                RowBox[{"scale", " ", 
                 RowBox[{"Cos", "[", "theta", "]"}]}], ")"}], " ", "+", " ", 
               "x"}], ",", " ", 
              RowBox[{
               RowBox[{"(", 
                RowBox[{"0.5", "scale", " ", 
                 RowBox[{"Sin", "[", "theta", "]"}]}], ")"}], " ", "+", " ", 
               "yE"}]}], "}"}]}], "\[IndentingNewLine]", "}"}], "]"}]}], 
        "}"}], ",", " ", 
       RowBox[{"GridLines", "->", "Automatic"}]}], "]"}], ",", " ", 
     RowBox[{"{", 
      RowBox[{"x2", ",", " ", 
       RowBox[{"-", "2"}], ",", " ", "2"}], "}"}], ",", " ", 
     RowBox[{"RefreshRate", "->", "60"}]}], "]"}], ",", "\[IndentingNewLine]", 
   RowBox[{"{", 
    RowBox[{"y", ",", " ", 
     RowBox[{"-", "1.5"}], ",", "1.5"}], "}"}]}], "\[IndentingNewLine]", 
  "]"}]}], "Input",
 CellChangeTimes->{{3.8784113791663427`*^9, 3.8784114098039446`*^9}, {
  3.878411477828472*^9, 3.8784116019967175`*^9}, {3.878411638788368*^9, 
  3.878411862060608*^9}, {3.8784118938619146`*^9, 3.8784121262653975`*^9}, {
  3.8784121623950605`*^9, 3.8784122370975475`*^9}, {3.878412817577856*^9, 
  3.8784128688885756`*^9}, {3.8784129087193365`*^9, 3.8784129149527874`*^9}},
 CellLabel->"In[17]:=",ExpressionUUID->"8256c685-7060-4d3b-98f2-9da0b3a2916c"],

Cell[BoxData[
 TagBox[
  StyleBox[
   DynamicModuleBox[{$CellContext`y$$ = 0.8650000000000002, Typeset`show$$ = 
    True, Typeset`bookmarkList$$ = {}, Typeset`bookmarkMode$$ = "Menu", 
    Typeset`animator$$, Typeset`animvar$$ = 1, Typeset`name$$ = 
    "\"untitled\"", Typeset`specs$$ = {{
      Hold[$CellContext`y$$], -1.5, 1.5}}, Typeset`size$$ = {
    409., {170.13403328722342`, 175.86596671277658`}}, Typeset`update$$ = 0, 
    Typeset`initDone$$, Typeset`skipInitDone$$ = True}, 
    DynamicBox[Manipulate`ManipulateBoxes[
     1, StandardForm, "Variables" :> {$CellContext`y$$ = -1.5}, 
      "ControllerVariables" :> {}, 
      "OtherVariables" :> {
       Typeset`show$$, Typeset`bookmarkList$$, Typeset`bookmarkMode$$, 
        Typeset`animator$$, Typeset`animvar$$, Typeset`name$$, 
        Typeset`specs$$, Typeset`size$$, Typeset`update$$, Typeset`initDone$$,
         Typeset`skipInitDone$$}, "Body" :> Animate[
        Graphics[{LightGray, 
          Rectangle[{(-4)/2, (-3)/2}, {4/2, 3/2}], Blue, 
          PointSize[0.01], 
          Point[
           $CellContext`SimulBeam[{4, 
            3}, $CellContext`elems, {$CellContext`x2, $CellContext`y$$, 
             0.005, -0.005}, 1000]], Black, 
          Thickness[0.01], 
          
          Line[{{(-$CellContext`scale) 
              Cos[$CellContext`theta] + $CellContext`x, (-0.5) \
$CellContext`scale 
              Sin[$CellContext`theta] + $CellContext`yE}, {$CellContext`scale 
              Cos[$CellContext`theta] + $CellContext`x, 
             0.5 $CellContext`scale 
              Sin[$CellContext`theta] + $CellContext`yE}}]}, GridLines -> 
         Automatic], {$CellContext`x2, -2, 2}, RefreshRate -> 60], 
      "Specifications" :> {{$CellContext`y$$, -1.5, 1.5}}, "Options" :> {}, 
      "DefaultOptions" :> {}],
     ImageSizeCache->{458., {215.13403328722342`, 220.86596671277658`}},
     SingleEvaluation->True],
    Deinitialization:>None,
    DynamicModuleValues:>{},
    SynchronousInitialization->True,
    UndoTrackedVariables:>{Typeset`show$$, Typeset`bookmarkMode$$},
    UnsavedVariables:>{Typeset`initDone$$},
    UntrackedVariables:>{Typeset`size$$}], "Manipulate",
   Deployed->True,
   StripOnInput->False],
  Manipulate`InterpretManipulate[1]]], "Output",
 CellChangeTimes->{{3.8784118482364426`*^9, 3.8784118624156876`*^9}, {
   3.878411919924903*^9, 3.878411960406973*^9}, 3.8784119967675004`*^9, {
   3.878412081741319*^9, 3.8784121267932553`*^9}, {3.878412162808023*^9, 
   3.878412183715525*^9}, {3.878412224897698*^9, 3.8784122376553593`*^9}, {
   3.878412840838751*^9, 3.8784128694229484`*^9}, 3.878412915586275*^9, {
   3.8784147783281507`*^9, 3.878414805111754*^9}},
 CellLabel->"Out[24]=",ExpressionUUID->"c5afe6c2-523b-4c18-a837-1e08f23aa696"]
}, Open  ]],

Cell["Element Functions:", "Text",
 CellChangeTimes->{{3.878407255138899*^9, 3.878407276163238*^9}, {
  3.8784112899193497`*^9, 
  3.8784112934464054`*^9}},ExpressionUUID->"7dd032cb-f0ed-41ac-b7aa-\
8e91ade66f88"],

Cell[BoxData[
 RowBox[{
  RowBox[{"BasicMirror", "[", 
   RowBox[{"elX_", ",", "elY_", ",", "elTheta_", ",", "elScale_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"check", ",", " ", "update", ",", "  ", "render"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"check", "[", "pos_", "]"}], " ", ":=", " ", 
      RowBox[{
       RowBox[{"Sign", "[", 
        RowBox[{"pos", "[", 
         RowBox[{"[", "2", "]"}], "]"}], "]"}], "!=", 
       RowBox[{"Sign", "[", 
        RowBox[{
         RowBox[{"pos", "[", 
          RowBox[{"[", "2", "]"}], "]"}], " ", "+", " ", 
         RowBox[{"pos", "[", 
          RowBox[{"[", "4", "]"}], "]"}]}], "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"update", "[", "pos_", "]"}], " ", ":=", " ", 
      RowBox[{"Module", "[", 
       RowBox[{
        RowBox[{"{", "res", "}"}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"res", " ", "=", " ", "pos"}], ";", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"res", "[", 
           RowBox[{"[", "4", "]"}], "]"}], " ", "=", " ", 
          RowBox[{"-", 
           RowBox[{"res", "[", 
            RowBox[{"[", "4", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"Return", "[", "res", "]"}]}]}], "\[IndentingNewLine]", 
       "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"render", "[", 
       RowBox[{"x_", ",", " ", "y_", ",", " ", "theta_", ",", " ", "scale_"}],
        "]"}], " ", ":=", " ", 
      RowBox[{"Module", "[", 
       RowBox[{
        RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
        RowBox[{"Return", "[", 
         RowBox[{"{", 
          RowBox[{"Black", ",", " ", 
           RowBox[{"Thickness", "[", "0.01", "]"}], ",", " ", 
           RowBox[{"Line", "[", 
            RowBox[{"{", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"0.5", " ", "scale", " ", 
                   RowBox[{"Sin", "[", 
                    RowBox[{"theta", "+", "Pi"}], "]"}]}], ")"}], " ", "+", 
                 " ", "x"}], ",", " ", 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"0.5", " ", "scale", " ", 
                   RowBox[{"Cos", "[", 
                    RowBox[{"theta", "+", "Pi"}], "]"}]}], ")"}], " ", "+", 
                 " ", "y"}]}], "}"}], ",", " ", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"0.5", "scale", " ", 
                   RowBox[{"Sin", "[", "theta", "]"}]}], ")"}], " ", "+", " ",
                  "x"}], ",", " ", 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"0.5", "scale", " ", 
                   RowBox[{"Cos", "[", "theta", "]"}]}], ")"}], " ", "+", " ",
                  "y"}]}], "}"}]}], "\[IndentingNewLine]", "}"}], "]"}]}], 
          "}"}], "]"}]}], "\[IndentingNewLine]", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Return", "[", 
      RowBox[{"<|", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"\"\<position\>\"", "->", 
         RowBox[{"{", 
          RowBox[{
          "elX", ",", " ", "elY", ",", " ", "elTheta", ",", " ", "elScale"}], 
          "}"}]}], ",", "\[IndentingNewLine]", 
        RowBox[{"\"\<check\>\"", "->", " ", "check"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"\"\<update\>\"", "->", " ", "update"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"\"\<graphics\>\"", " ", "->", " ", "render"}]}], 
       "\[IndentingNewLine]", "|>"}], "]"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.878407325716136*^9, 3.8784074650096145`*^9}, {
  3.878411041545141*^9, 3.8784110794542007`*^9}},
 CellLabel->"In[16]:=",ExpressionUUID->"c17c50a1-f920-4dc6-95f9-8f16c2a42811"],

Cell[BoxData[""], "Input",
 CellChangeTimes->{{3.878405709219878*^9, 3.878405727795679*^9}, {
  3.8784057947378635`*^9, 3.8784058239345336`*^9}},
 CellLabel->"In[15]:=",ExpressionUUID->"621e5bc2-2416-44da-a05b-9e74cb3bacaf"]
}, Open  ]]
},
WindowSize->{766.8, 820.8},
WindowMargins->{{Automatic, -4.7999999999999545`}, {Automatic, 0}},
FrontEndVersion->"13.1 for Microsoft Windows (64-bit) (August 22, 2022)",
StyleDefinitions->"Default.nb",
ExpressionUUID->"76737a91-7d1d-4304-848f-7779118f13a9"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[CellGroupData[{
Cell[580, 22, 191, 3, 53, "Subtitle",ExpressionUUID->"2721a7f5-4ddf-4257-a80b-a28a90a9608e"],
Cell[774, 27, 3156, 71, 314, "Input",ExpressionUUID->"fff4261a-3d7c-450d-b6ce-752fc2fac155"],
Cell[3933, 100, 5695, 131, 428, "Input",ExpressionUUID->"22dbdbaf-fc12-4a2b-9c4b-17fb2b017295"],
Cell[9631, 233, 1788, 41, 257, "Input",ExpressionUUID->"178196de-50ca-489f-8b47-c863725895d8"],
Cell[11422, 276, 1525, 40, 86, "Input",ExpressionUUID->"eba29eb1-59bf-4695-ace5-bca8568c2336"]
}, Open  ]],
Cell[CellGroupData[{
Cell[12984, 321, 240, 7, 85, "Subtitle",ExpressionUUID->"337f5d3f-2283-47e0-9508-051921e559d7"],
Cell[13227, 330, 147, 3, 35, "Text",ExpressionUUID->"7e075a3e-631e-44f6-9b82-59f4916dfc1f"],
Cell[13377, 335, 3543, 79, 352, "Input",ExpressionUUID->"2af5c833-3f8a-450b-be20-c8e5b9002d07"],
Cell[16923, 416, 169, 3, 35, "Text",ExpressionUUID->"effa050d-f55b-4328-ad6f-4911e89fddc2"],
Cell[CellGroupData[{
Cell[17117, 423, 8826, 217, 809, "Input",ExpressionUUID->"8256c685-7060-4d3b-98f2-9da0b3a2916c"],
Cell[25946, 642, 2764, 54, 455, "Output",ExpressionUUID->"c5afe6c2-523b-4c18-a837-1e08f23aa696"]
}, Open  ]],
Cell[28725, 699, 213, 4, 35, "Text",ExpressionUUID->"7dd032cb-f0ed-41ac-b7aa-8e91ade66f88"],
Cell[28941, 705, 3989, 97, 390, "Input",ExpressionUUID->"c17c50a1-f920-4dc6-95f9-8f16c2a42811"],
Cell[32933, 804, 224, 3, 28, "Input",ExpressionUUID->"621e5bc2-2416-44da-a05b-9e74cb3bacaf"]
}, Open  ]]
}
]
*)

